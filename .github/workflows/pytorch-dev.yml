name: Update PyTorch Templates

on:
  push:
    branches-ignore:
      - main
    paths:
      - "official-templates/pytorch/**"
  pull_request:
    paths:
      - "official-templates/pytorch/**"
  workflow_dispatch:
    inputs:
      specific_template:
        description: "Specific template to update (leave empty to update all)"
        required: false
        type: string

jobs:
  update-templates:
    runs-on: ubuntu-latest-public-m
    strategy:
      fail-fast: false
      matrix:
        include:
          # Map PyTorch variants to template IDs
          # CUDA variants
          - target: 210-py310-cuda1180-devel-ubuntu2204
            template_id: runpod-torch-v21
          - target: 240-py311-cuda1241-devel-ubuntu2204
            template_id: runpod-torch-v240
          - target: 220-py310-cuda1211-devel-ubuntu2204
            template_id: runpod-torch-v220
          - target: 211-py310-cuda1211-devel-ubuntu2204
            template_id: runpod-torch-v211
          - target: 201-py310-cuda1180-devel-ubuntu2204
            template_id: runpod-torch
          - target: 1131-py38-cuda1171-devel-ubuntu2204
            template_id: runpod-torch-v1
          # ROCM variants
          - target: 240-py310-rocm610-ubuntu2204
            template_id: runpod-torch-v240-rocm61
          - target: 201-py310-rocm57-ubuntu2204
            template_id: runpod-torch-v201-rocm57
          - target: 201-py39-rocm61-ubuntu2004
            template_id: runpod-torch-v201-rocm61
          - target: 201-py38-rocm56-ubuntu2004
            template_id: runpod-torch-v201-rocm56
          - target: 211-py39-rocm60-ubuntu2004
            template_id: runpod-torch-v211-rocm60
          - target: 212-py310-rocm602-ubuntu2204
            template_id: runpod-torch-v212-rocm602
          - target: 212-py310-rocm61-ubuntu2204
            template_id: runpod-torch-v212-rocm61

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Skip if specific template is set and doesn't match
        id: check_template
        run: |
          if [[ "${{ github.event.inputs.specific_template }}" != "" && "${{ github.event.inputs.specific_template }}" != "${{ matrix.template_id }}" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Make script executable
        if: steps.check_template.outputs.skip != 'true'
        run: chmod +x official-templates/pytorch/update-template.sh

      - name: Update template via script
        if: steps.check_template.outputs.skip != 'true'
        env:
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
        run: ./official-templates/pytorch/update-template.sh ${{ matrix.template_id }}
