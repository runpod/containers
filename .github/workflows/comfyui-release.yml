name: ComfyUI Production Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version (e.g., 6.0.0)"
        required: true
      comfyui_version:
        description: "ComfyUI version tag (e.g., v0.3.10)"
        required: true
  push:
    paths:
      - "official-templates/stable-diffusion-comfyui/**"
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest-public-m
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Clear space to remove unused folders
        run: |
          rm -rf /usr/share/dotnet
          rm -rf /opt/ghc
          rm -rf "/usr/local/share/boost"
          rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set environment variables
        run: |
          # For production releases, we use the version number directly without any prefix
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "RELEASE=${{ github.event.inputs.release_version }}" >> $GITHUB_ENV
            echo "COMFYUI_VERSION=${{ github.event.inputs.comfyui_version }}" >> $GITHUB_ENV
          fi
          # Set environment variable to disable entitlements checks
          echo "BUILDX_BAKE_ENTITLEMENTS_FS=0" >> $GITHUB_ENV
          # Set Docker Hub repo and image name
          echo "DOCKERHUB_REPO=runpod" >> $GITHUB_ENV
          echo "DOCKERHUB_IMG=stable-diffusion" >> $GITHUB_ENV

      - name: Build and push the images to Docker Hub
        uses: docker/bake-action@v2
        with:
          files: ./official-templates/stable-diffusion-comfyui/docker-bake.hcl
          push: true
          set: |
            ${{ github.event_name == 'workflow_dispatch' && format('*.args.RELEASE={0}', env.RELEASE) || '' }}
            ${{ github.event_name == 'workflow_dispatch' && format('*.args.COMFYUI_VERSION={0}', env.COMFYUI_VERSION) || '' }}
            *.args.GITHUB_WORKSPACE=${{ github.workspace }}

      - name: Update description on Docker Hub
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_REPO }}/${{ env.DOCKERHUB_IMG }}
          readme-filepath: ./official-templates/stable-diffusion-comfyui/README.md
